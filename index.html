<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>AI Th·ªùi ti·∫øt & Du l·ªãch</title>
  <style>
    /* ... ( to√†n b·ªô CSS t·ª´ l·∫ßn tr∆∞·ªõc gi·ªØ nguy√™n ) ... */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #74ebd5, #ACB6E5);
      display: flex;
      justify-content: center;
      align-items: flex-start; 
      min-height: 100vh;
      margin: 0;
      padding: 2rem;
    }
    .container {
      background-color: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 900px; 
      display: flex;
      gap: 2rem; 
    }

    .input-column {
      flex: 1; 
      display: flex;
      flex-direction: column;
    }

    .output-column {
      flex: 1.5; 
      display: flex; 
      flex-direction: column;
    }

    h2 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: #333;
      text-align: center; 
    }
    input[type="text"] {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 1rem;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input[type="text"]:focus {
      border-color: #0077ff;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
      outline: none;
    }
    button {
      padding: 0.75rem 1.5rem;
      background-color: #0077ff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s;
      width: 100%; 
    }
    button:hover {
      background-color: #005fcc;
    }
    button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }

    #response {
      background-color: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      font-size: 0.95rem;
      color: #343a40;
      line-height: 1.65;
      text-align: left;
      opacity: 0;
      transform: translateY(15px);
      transition: opacity 0.4s ease-out, transform 0.4s ease-out;
      width: 100%; 
      min-height: 200px; 
      overflow-y: auto; 
    }

    #response.visible {
      opacity: 1;
      transform: translateY(0);
    }

    #response.error {
      color: #721c24;
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }

    #response.loading {
      color: #004085;
      background-color: #cce5ff;
      border-color: #b8daff;
      font-style: italic;
      text-align: center; 
    }

    #response ul {
      list-style-type: none; 
      padding-left: 0; 
      margin-top: 0.75rem; 
    }

    #response li {
      margin-bottom: 0.5rem; 
    }

    #response a { /* Style chung cho c√°c link trong response */
      color: #0056b3; 
      text-decoration: none; 
      padding: 0.2rem 0.4rem; /* Gi·∫£m padding m·ªôt ch√∫t cho link th∆∞·ªùng */
      border-radius: 4px; 
      transition: background-color 0.2s, color 0.2s, text-decoration 0.2s;
    }
     #response a:hover, #response a:focus {
      text-decoration: underline; /* Th√™m g·∫°ch ch√¢n khi hover link th∆∞·ªùng */
    }


    /* Style ri√™ng cho link ch·ªâ ƒë∆∞·ªùng / t√¨m ƒë·ªãa ƒëi·ªÉm c·ª• th·ªÉ */
    #response a.map-navigation-link {
      background-color: #007bff; /* M√†u n·ªÅn gi·ªëng n√∫t */
      color: white;
      padding: 0.5rem 1rem; /* Padding l·ªõn h∆°n */
      display: inline-block; 
      margin-top: 0.5rem; /* Kho·∫£ng c√°ch v·ªõi text ph√≠a tr√™n */
      font-weight: bold;
      text-decoration: none !important; /* Lu√¥n b·ªè g·∫°ch ch√¢n cho n√∫t n√†y */
    }
    #response a.map-navigation-link:hover,
    #response a.map-navigation-link:focus {
      background-color: #005fcc; /* M√†u n·ªÅn ƒë·∫≠m h∆°n khi hover */
      color: white;
    }
     #response small { /* Style cho ch√∫ th√≠ch nh·ªè */
        display: block;
        margin-top: 0.75rem;
        font-size: 0.85em;
        color: #6c757d;
    }


    @media (max-width: 768px) {
      .container {
        flex-direction: column; 
        max-width: 450px; 
        align-items: stretch; 
      }
      .input-column, .output-column {
        flex-basis: auto; 
        width: 100%;
      }
      .output-column {
         margin-top: 1.5rem; 
      }
      button {
         width: auto; 
         align-self: center; 
      }
    }
    @media (max-width: 480px) {
        body { padding: 1rem; }
        .container { padding: 1.5rem; }
        h2 { font-size: 1.3rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="input-column">
      <h2>üå§Ô∏è AI Tra C·ª©u Th·ªùi Ti·∫øt & Du L·ªãch & ƒê·ªãa ƒêi·ªÉm</h2>
      <input type="text" id="questionInput" placeholder="H·ªèi th·ªùi ti·∫øt, ƒë·ªãa ƒëi·ªÉm, ch·ªâ ƒë∆∞·ªùng...">
      <button onclick="askWithLocation()">Tra c·ª©u</button>
    </div>
    
    <div class="output-column">
      <div id="response"></div>
    </div>
  </div>

  <script>
    const questionInputElement = document.getElementById("questionInput");
    const responseElement = document.getElementById("response");
    const submitButton = document.querySelector(".input-column button");

    // H√†m m·ªõi ƒë·ªÉ l·∫•y v·ªã tr√≠ v√† g·ªçi API
    async function askWithLocation() {
        const question = questionInputElement.value.trim();
        if (!question) {
            responseElement.innerHTML = "Vui l√≤ng nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n.";
            responseElement.classList.add('error', 'visible');
            return;
        }

        // Hi·ªÉn th·ªã loading ngay
        responseElement.innerHTML = "ƒêang x·ª≠ l√Ω y√™u c·∫ßu...";
        responseElement.classList.remove('error'); // X√≥a l·ªói c≈© n·∫øu c√≥
        responseElement.classList.add('loading', 'visible');
        submitButton.disabled = true;
        questionInputElement.disabled = true;

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Th√†nh c√¥ng: g·ªçi callApiWithQuestion v·ªõi t·ªça ƒë·ªô
                    callApiWithQuestion(question, position.coords.latitude, position.coords.longitude);
                },
                (error) => {
                    // L·ªói ho·∫∑c t·ª´ ch·ªëi: g·ªçi callApiWithQuestion kh√¥ng c√≥ t·ªça ƒë·ªô
                    console.warn(`L·ªói khi l·∫•y v·ªã tr√≠: ${error.message}. Ti·∫øp t·ª•c kh√¥ng c√≥ v·ªã tr√≠.`);
                    responseElement.innerHTML = "ƒêang x·ª≠ l√Ω y√™u c·∫ßu... (Kh√¥ng c√≥ v·ªã tr√≠)"; // C·∫≠p nh·∫≠t th√¥ng b√°o
                    callApiWithQuestion(question, null, null);
                },
                { timeout: 7000, enableHighAccuracy: false } // Th√™m timeout v√† t√πy ch·ªçn ƒë·ªô ch√≠nh x√°c
            );
        } else {
            // Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation
            console.warn("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation. Ti·∫øp t·ª•c kh√¥ng c√≥ v·ªã tr√≠.");
            responseElement.innerHTML = "ƒêang x·ª≠ l√Ω y√™u c·∫ßu... (Kh√¥ng c√≥ v·ªã tr√≠)";
            callApiWithQuestion(question, null, null);
        }
    }

    async function callApiWithQuestion(question, lat, lon) {
      // responseElement ƒë√£ ·ªü tr·∫°ng th√°i loading t·ª´ askWithLocation

      try {
        let apiUrl = `http://localhost:8000/ask?question=${encodeURIComponent(question)}`;
        if (lat !== null && lon !== null) {
          apiUrl += `&latitude=${lat}&longitude=${lon}`;
        }
        // console.log("Calling API URL:", apiUrl); // Debug URL

        const res = await fetch(apiUrl);
        const data = await res.json();

        responseElement.classList.remove('loading');

        if (data && data.message) {
            // Backend c√≥ th·ªÉ tr·∫£ v·ªÅ HTML (cho danh s√°ch ƒë·ªãa ƒëi·ªÉm, ch·ªâ ƒë∆∞·ªùng) ho·∫∑c text thu·∫ßn
            // innerHTML s·∫Ω render HTML, v√† hi·ªÉn th·ªã text thu·∫ßn nh∆∞ b√¨nh th∆∞·ªùng
            // N·∫øu text thu·∫ßn c√≥ \n v√† mu·ªën th√†nh <br>, c·∫ßn x·ª≠ l√Ω ri√™ng
            const isHtmlResponse = data.message.includes("<a href") || data.message.includes("<ul>");
            if (isHtmlResponse) {
                 responseElement.innerHTML = data.message;
            } else {
                 responseElement.innerHTML = data.message.replace(/\n/g, '<br>');
            }
            
            const messageLowerCase = data.message.toLowerCase();
            const isErrorIndicating = (messageLowerCase.includes("l·ªói") || 
                messageLowerCase.includes("kh√¥ng t√¨m th·∫•y") ||
                messageLowerCase.includes("kh√¥ng th·ªÉ") ||
                messageLowerCase.includes("xin l·ªói, t√¥i") ||
                messageLowerCase.includes("g·∫∑p s·ª± c·ªë"));
            // Kh√¥ng ƒë√°nh d·∫•u l·ªói n·∫øu l√† th√¥ng b√°o t√¨m ƒë·ªãa ƒëi·ªÉm th√†nh c√¥ng ho·∫∑c g·ª£i √Ω
            const isSuccessPlaceMessage = messageLowerCase.includes("d∆∞·ªõi ƒë√¢y l√† m·ªôt s·ªë g·ª£i √Ω") || messageLowerCase.includes("ch·ªâ ƒë∆∞·ªùng ƒë·∫øn") || messageLowerCase.includes("t√¨m") && messageLowerCase.includes("tr√™n b·∫£n ƒë·ªì");

            if (isErrorIndicating && !isSuccessPlaceMessage) {
                responseElement.classList.add('error');
            } else if (!res.ok && !isSuccessPlaceMessage) {
                 responseElement.classList.add('error');
            }
            else {
                responseElement.classList.remove('error');
            }
        } else {
            responseElement.innerHTML = "ƒê√£ c√≥ l·ªói x·∫£y ra. Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá t·ª´ m√°y ch·ªß.";
            responseElement.classList.add('error');
        }

      } catch (error) {
        console.error("L·ªói khi g·ªçi API:", error);
        responseElement.classList.remove('loading');
        responseElement.innerHTML = "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß ho·∫∑c ƒë√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.";
        responseElement.classList.add('error');
      } finally {
        submitButton.disabled = false;
        questionInputElement.disabled = false;
        if (responseElement.innerHTML.trim() !== "") {
             if (!responseElement.classList.contains('visible')) {
                responseElement.classList.add('visible');
            }
        } else {
            responseElement.classList.remove('visible'); 
        }
      }
    }

    // C·∫≠p nh·∫≠t s·ª± ki·ªán click c·ªßa n√∫t ƒë·ªÉ g·ªçi askWithLocation
    // document.querySelector(".input-column button").onclick = askWithLocation; // G√°n tr·ª±c ti·∫øp
    // Ho·∫∑c gi·ªØ nguy√™n onclick="askWithLocation()" trong HTML

    // Cho ph√©p nh·∫•n Enter ƒë·ªÉ g·ª≠i
    questionInputElement.addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault(); 
            askWithLocation(); // G·ªçi h√†m m·ªõi khi nh·∫•n Enter
        }
    });
  </script>
</body>
</html>